<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperAirDrop</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Ad Script Integration -->
    <script src='//libtl.com/sdk.js' data-zone='10008240' data-sdk='show_10008240'></script>
    <style>
        /* Global Styles */
        :root {
            --primary-color: #0088cc;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --bg-color: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --card-bg: #ffffff;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --border-color: #333333;
            --card-bg: #1e1e1e;
            --shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 0 15px;
            margin: 0 auto;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .btn {
            display: inline-block;
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            user-select: none;
            border: 1px solid transparent;
            padding: 8px 16px;
            font-size: 14px;
            line-height: 1.5;
            border-radius: 6px;
            transition: all 0.15s ease-in-out;
            cursor: pointer;
        }

        .btn-primary {
            color: #fff;
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-success {
            color: #fff;
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        .btn-warning {
            color: #212529;
            background-color: var(--warning-color);
            border-color: var(--warning-color);
        }

        .btn-danger {
            color: #fff;
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .btn-secondary {
            color: #fff;
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            display: block;
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--card-bg);
            background-clip: padding-box;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: 0;
            box-shadow: 0 0 0 2px rgba(0, 136, 204, 0.25);
        }

        .text-center {
            text-align: center;
        }

        .d-none {
            display: none !important;
        }

        .d-flex {
            display: flex;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .align-items-center {
            align-items: center;
        }

        .mb-2 {
            margin-bottom: 8px;
        }

        .mb-3 {
            margin-bottom: 16px;
        }

        .mt-3 {
            margin-top: 16px;
        }

        .p-3 {
            padding: 16px;
        }

        .h4 {
            font-size: 1.5rem;
            font-weight: 500;
            line-height: 1.2;
        }

        .h5 {
            font-size: 1.25rem;
            font-weight: 500;
            line-height: 1.2;
        }

        .h6 {
            font-size: 1rem;
            font-weight: 500;
            line-height: 1.2;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 500;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 6px;
        }

        .badge-success {
            color: #fff;
            background-color: var(--success-color);
        }

        .badge-warning {
            color: #212529;
            background-color: var(--warning-color);
        }

        .badge-danger {
            color: #fff;
            background-color: var(--danger-color);
        }

        .badge-secondary {
            color: #fff;
            background-color: var(--secondary-color);
        }

        .progress {
            display: flex;
            height: 8px;
            overflow: hidden;
            font-size: 12px;
            background-color: #e9ecef;
            border-radius: 4px;
        }

        .progress-bar {
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
            color: #fff;
            text-align: center;
            white-space: nowrap;
            background-color: var(--primary-color);
            transition: width 0.6s ease;
        }

        .tab-content {
            margin-top: 16px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            padding-left: 0;
            margin-bottom: 0;
            list-style: none;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-tabs .nav-item {
            margin-bottom: -1px;
        }

        .nav-tabs .nav-link {
            display: block;
            padding: 8px 16px;
            border: 1px solid transparent;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            color: var(--text-color);
            text-decoration: none;
            cursor: pointer;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            background-color: var(--card-bg);
            border-color: var(--border-color) var(--border-color) var(--card-bg);
        }

        .table {
            width: 100%;
            margin-bottom: 16px;
            color: var(--text-color);
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px;
            vertical-align: top;
            border-top: 1px solid var(--border-color);
        }

        .table thead th {
            vertical-align: bottom;
            border-bottom: 2px solid var(--border-color);
        }

        .table tbody + tbody {
            border-top: 2px solid var(--border-color);
        }

        /* User Panel Styles */
        #user-panel {
            padding-bottom: 70px;
        }

        .user-header {
            padding: 16px;
            background: linear-gradient(135deg, var(--primary-color), #0056b3);
            color: white;
            border-radius: 0 0 20px 20px;
            margin-bottom: 16px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .user-details h2 {
            margin: 0;
            font-size: 18px;
        }

        .user-details p {
            margin: 0;
            opacity: 0.9;
        }

        .balance-card {
            background: white;
            color: #333;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .balance-card h3 {
            margin: 0 0 8px;
            font-size: 14px;
            opacity: 0.8;
        }

        .balance-card .amount {
            font-size: 28px;
            font-weight: bold;
            margin: 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-card h4 {
            font-size: 14px;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .stat-card p {
            font-size: 20px;
            font-weight: bold;
            margin: 0;
        }

        .chart-container {
            height: 200px;
            margin-bottom: 16px;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: var(--shadow);
            text-decoration: none;
            color: var(--text-color);
        }

        .action-btn i {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .task-info h4 {
            margin: 0 0 4px;
            font-size: 16px;
        }

        .task-info p {
            margin: 0;
            font-size: 14px;
            opacity: 0.8;
        }

        .task-reward {
            font-weight: bold;
            color: var(--success-color);
        }

        .ad-progress {
            margin-bottom: 16px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .leaderboard-rank {
            width: 30px;
            text-align: center;
            font-weight: bold;
            margin-right: 12px;
        }

        .leaderboard-user {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--border-color);
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .leaderboard-details h4 {
            margin: 0;
            font-size: 16px;
        }

        .leaderboard-details p {
            margin: 0;
            font-size: 14px;
            opacity: 0.8;
        }

        .leaderboard-score {
            font-weight: bold;
        }

        .referral-link {
            display: flex;
            margin-bottom: 16px;
        }

        .referral-link input {
            flex: 1;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .referral-link .btn {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }

        .withdrawal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .withdrawal-info h4 {
            margin: 0 0 4px;
            font-size: 16px;
        }

        .withdrawal-info p {
            margin: 0;
            font-size: 14px;
            opacity: 0.8;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-color);
            font-size: 12px;
            flex: 1;
        }

        .nav-item.active {
            color: var(--primary-color);
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        /* Admin Panel Styles */
        #admin-panel {
            min-height: 100vh;
            background-color: var(--bg-color);
        }

        .admin-header {
            background-color: var(--primary-color);
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-nav {
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 0 16px;
        }

        .admin-nav-list {
            display: flex;
            list-style: none;
            overflow-x: auto;
        }

        .admin-nav-item {
            padding: 12px 16px;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
        }

        .admin-nav-item.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .admin-content {
            padding: 16px;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .admin-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .admin-card h3 {
            font-size: 14px;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .admin-card .value {
            font-size: 24px;
            font-weight: bold;
        }

        .data-table {
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .table-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-container {
            overflow-x: auto;
        }

        .pagination {
            display: flex;
            justify-content: center;
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }

        .page-item {
            margin: 0 4px;
        }

        .page-link {
            display: block;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            text-decoration: none;
            color: var(--text-color);
        }

        .page-item.active .page-link {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .form-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
        }

        .theme-toggle {
            position: fixed;
            top: 16px;
            right: 16px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            box-shadow: var(--shadow);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1100;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            opacity: 0.7;
        }

        .close:hover {
            opacity: 1;
        }

        /* Animation for ad watching */
        @keyframes countdown {
            from { width: 100%; }
            to { width: 0%; }
        }

        .ad-countdown {
            height: 4px;
            background-color: var(--primary-color);
            width: 100%;
            animation: countdown 15s linear forwards;
        }

        .ad-container {
            text-align: center;
            padding: 20px;
        }

        .ad-placeholder {
            width: 100%;
            height: 200px;
            background-color: var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        /* Ad Banner Styles */
        .ad-banner {
            width: 100%;
            margin: 16px 0;
            text-align: center;
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid var(--border-color);
        }

        .ad-banner iframe {
            max-width: 100%;
            border: none;
        }

        /* Mining Graph Styles */
        .mining-graph {
            display: flex;
            align-items: flex-end;
            height: 150px;
            justify-content: space-between;
            padding: 0 10px;
        }

        .graph-bar {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 12%;
        }

        .graph-bar-value {
            width: 100%;
            background: linear-gradient(to top, var(--primary-color), #0056b3);
            border-radius: 4px 4px 0 0;
            min-height: 10px;
            transition: height 0.5s ease;
        }

        .graph-bar-label {
            margin-top: 8px;
            font-size: 12px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <div class="theme-toggle" id="theme-toggle">
        <i id="theme-icon">🌙</i>
    </div>

    <!-- User Panel (Telegram Mini App) -->
    <div id="user-panel" class="d-none">
        <!-- Header -->
        <div class="user-header">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">
                    <i>👤</i>
                </div>
                <div class="user-details">
                    <h2 id="user-name">User Name</h2>
                    <p id="user-username">@username</p>
                </div>
            </div>
            <div class="balance-card">
                <h3>Main Balance</h3>
                <p class="amount" id="main-balance">0.00 USDT</p>
            </div>
        </div>

        <!-- Navigation Content -->
        <div class="container">
            <!-- Home Screen -->
            <div id="home-screen" class="tab-pane active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Today's Ads</h4>
                        <p id="today-ads">0/20</p>
                    </div>
                    <div class="stat-card">
                        <h4>Total Referrals</h4>
                        <p id="total-referrals">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Total Ads</h4>
                        <p id="total-ads">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Total Income</h4>
                        <p id="total-income">0.00 USDT</p>
                    </div>
                </div>

                <div class="card">
                    <h4 class="mb-3">Weekly Earnings</h4>
                    <div class="chart-container">
                        <div class="mining-graph" id="mining-graph">
                            <!-- Graph bars will be generated dynamically -->
                        </div>
                    </div>
                </div>

                <div class="quick-actions">
                    <a href="#" class="action-btn">
                        <i>👥</i>
                        <span>Join Community</span>
                    </a>
                    <a href="#" class="action-btn">
                        <i>🐦</i>
                        <span>Follow on X</span>
                    </a>
                </div>
            </div>

            <!-- Tasks Screen -->
            <div id="tasks-screen" class="tab-pane">
                <div class="card">
                    <h4 class="mb-3">Earning Wallet</h4>
                    <p class="mb-2">Current Balance: <strong id="earning-balance">0.00 USDT</strong></p>
                    <p class="mb-3" id="min-transfer-text">Minimum 10 USDT to transfer</p>
                    <button class="btn btn-primary w-100" id="transfer-btn" disabled>Transfer to Main Balance</button>
                </div>

                <div class="card">
                    <h4 class="mb-3">Daily Ad Progress</h4>
                    <div class="ad-progress">
                        <div class="progress-info">
                            <span>Progress</span>
                            <span id="ad-progress-text">0/20</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" id="ad-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100" id="watch-ad-btn">Watch Ad (0.05 USDT)</button>
                </div>

                <div class="card">
                    <h4 class="mb-3">Bonus Tasks</h4>
                    <div id="bonus-tasks-list">
                        <!-- Tasks will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Leaderboard Screen -->
            <div id="leaderboard-screen" class="tab-pane">
                <ul class="nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-tab="referrers-tab">Top Referrers</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-tab="earners-tab">Top Earners</a>
                    </li>
                </ul>

                <div class="tab-content">
                    <div id="referrers-tab" class="tab-pane active">
                        <div id="referrers-list">
                            <!-- Top referrers will be populated here -->
                        </div>
                    </div>
                    <div id="earners-tab" class="tab-pane">
                        <div id="earners-list">
                            <!-- Top earners will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Screen -->
            <div id="profile-screen" class="tab-pane">
                <div class="card">
                    <h4 class="mb-3">Invite Friends & Earn</h4>
                    <p class="mb-3">Invite your friends and earn 0.50 USDT for each successful referral!</p>
                    <div class="referral-link">
                        <input type="text" id="referral-link-input" class="form-control" readonly value="https://t.me/YourBotUsername/SuperAirDrop?startapp=ref_123456">
                        <button class="btn btn-primary" id="copy-link-btn">Copy</button>
                    </div>
                </div>

                <div class="card">
                    <h4 class="mb-3">Withdraw Funds</h4>
                    <p class="mb-3" id="withdrawal-condition">You are eligible for withdrawal.</p>
                    <button class="btn btn-primary w-100" id="withdraw-btn">Request Withdraw</button>
                </div>

                <div class="card">
                    <h4 class="mb-3">Withdrawal History</h4>
                    <div id="withdrawal-history">
                        <!-- Withdrawal history will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <a href="#" class="nav-item active" data-screen="home-screen">
                <i class="nav-icon">🏠</i>
                <span>Home</span>
            </a>
            <a href="#" class="nav-item" data-screen="tasks-screen">
                <i class="nav-icon">📋</i>
                <span>Tasks</span>
            </a>
            <a href="#" class="nav-item" data-screen="leaderboard-screen">
                <i class="nav-icon">🏆</i>
                <span>Leaderboard</span>
            </a>
            <a href="#" class="nav-item" data-screen="profile-screen">
                <i class="nav-icon">👤</i>
                <span>Profile</span>
            </a>
        </div>
    </div>

    <!-- Admin Panel (Browser View) -->
    <div id="admin-panel" class="d-none">
        <!-- Admin Login Screen -->
        <div id="admin-login" class="login-container">
            <div class="login-card">
                <h2 class="text-center mb-3">Admin Login</h2>
                <div class="form-group">
                    <label class="form-label" for="admin-email">Email</label>
                    <input type="email" class="form-control" id="admin-email" placeholder="admin@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label" for="admin-password">Password</label>
                    <input type="password" class="form-control" id="admin-password" placeholder="Enter password">
                </div>
                <button class="btn btn-primary w-100" id="admin-login-btn">Login</button>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="d-none">
            <div class="admin-header">
                <h2>SuperAirDrop Admin</h2>
                <button class="btn btn-secondary" id="admin-logout-btn">Logout</button>
            </div>

            <div class="admin-nav">
                <ul class="admin-nav-list">
                    <li class="admin-nav-item active" data-admin-tab="dashboard-tab">Dashboard</li>
                    <li class="admin-nav-item" data-admin-tab="users-tab">User Management</li>
                    <li class="admin-nav-item" data-admin-tab="tasks-tab">Task Management</li>
                    <li class="admin-nav-item" data-admin-tab="withdrawals-tab">Withdrawals</li>
                    <li class="admin-nav-item" data-admin-tab="config-tab">App Configuration</li>
                </ul>
            </div>

            <div class="admin-content">
                <!-- Dashboard Tab -->
                <div id="dashboard-tab" class="admin-tab active">
                    <div class="stats-cards">
                        <div class="admin-card">
                            <h3>Total Users</h3>
                            <p class="value" id="admin-total-users">0</p>
                        </div>
                        <div class="admin-card">
                            <h3>Total USDT Earned</h3>
                            <p class="value" id="admin-total-earned">0 USDT</p>
                        </div>
                        <div class="admin-card">
                            <h3>Pending Withdrawals</h3>
                            <p class="value" id="admin-pending-withdrawals">0</p>
                        </div>
                        <div class="admin-card">
                            <h3>Approved Withdrawals</h3>
                            <p class="value" id="admin-approved-withdrawals">0</p>
                        </div>
                    </div>
                </div>

                <!-- User Management Tab -->
                <div id="users-tab" class="admin-tab">
                    <div class="data-table">
                        <div class="table-header">
                            <h3>User Management</h3>
                            <div class="d-flex">
                                <input type="text" class="form-control" id="user-search" placeholder="Search users...">
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>User ID</th>
                                        <th>Username</th>
                                        <th>Main Balance</th>
                                        <th>Earning Balance</th>
                                        <th>Referrals</th>
                                        <th>Join Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    <!-- Users will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination">
                            <ul class="pagination-list" id="users-pagination">
                                <!-- Pagination will be populated here -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Task Management Tab -->
                <div id="tasks-tab" class="admin-tab">
                    <div class="form-card">
                        <h3 class="mb-3">Add New Task</h3>
                        <div class="form-group">
                            <label class="form-label" for="task-title">Task Title</label>
                            <input type="text" class="form-control" id="task-title" placeholder="Enter task title">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="task-description">Description</label>
                            <textarea class="form-control" id="task-description" placeholder="Enter task description"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="task-reward">Reward Amount (USDT)</label>
                            <input type="number" class="form-control" id="task-reward" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="task-url">URL/Instruction</label>
                            <input type="text" class="form-control" id="task-url" placeholder="Enter URL or instruction">
                        </div>
                        <button class="btn btn-primary" id="add-task-btn">Add Task</button>
                    </div>

                    <div class="data-table">
                        <div class="table-header">
                            <h3>Bonus Tasks</h3>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Description</th>
                                        <th>Reward</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tasks-table-body">
                                    <!-- Tasks will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Withdrawals Tab -->
                <div id="withdrawals-tab" class="admin-tab">
                    <div class="data-table">
                        <div class="table-header">
                            <h3>Pending Withdrawal Requests</h3>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Username</th>
                                        <th>Amount</th>
                                        <th>Wallet Address</th>
                                        <th>Method</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="withdrawals-table-body">
                                    <!-- Withdrawals will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- App Configuration Tab -->
                <div id="config-tab" class="admin-tab">
                    <div class="form-card">
                        <h3 class="mb-3">App Configuration</h3>
                        <div class="form-group">
                            <label class="form-label" for="daily-ad-reward">Daily Ad Reward (USDT)</label>
                            <input type="number" class="form-control" id="daily-ad-reward" placeholder="0.05" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="daily-ad-limit">Daily Ad Limit</label>
                            <input type="number" class="form-control" id="daily-ad-limit" placeholder="20">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="referral-bonus">Referral Bonus (USDT)</label>
                            <input type="number" class="form-control" id="referral-bonus" placeholder="0.50" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="min-transfer-amount">Min Transfer Amount (USDT)</label>
                            <input type="number" class="form-control" id="min-transfer-amount" placeholder="10" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="min-withdrawal-referrals">Min Withdrawal Referrals</label>
                            <input type="number" class="form-control" id="min-withdrawal-referrals" placeholder="0">
                            <small class="form-text text-muted">Set to 0 to allow withdrawal without referrals</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="withdrawal-methods">Withdrawal Methods (JSON)</label>
                            <textarea class="form-control" id="withdrawal-methods" placeholder='[{"name": "USDT (BEP-20)", "min": 50}, {"name": "USDT (TRC-20)", "min": 50}]' rows="4"></textarea>
                        </div>
                        <button class="btn btn-primary" id="save-config-btn">Save Configuration</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- User Edit Modal -->
    <div id="user-edit-modal" class="modal d-none">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Edit User</h5>
                <span class="close" data-modal="user-edit-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="edit-user-id">User ID</label>
                    <input type="text" class="form-control" id="edit-user-id" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-username">Username</label>
                    <input type="text" class="form-control" id="edit-username">
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-main-balance">Main Balance (USDT)</label>
                    <input type="number" class="form-control" id="edit-main-balance" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-earning-balance">Earning Balance (USDT)</label>
                    <input type="number" class="form-control" id="edit-earning-balance" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-referrals">Referrals</label>
                    <input type="number" class="form-control" id="edit-referrals">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-modal="user-edit-modal">Cancel</button>
                <button class="btn btn-primary" id="save-user-btn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div id="withdrawal-modal" class="modal d-none">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Request Withdrawal</h5>
                <span class="close" data-modal="withdrawal-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="withdrawal-method">Method</label>
                    <select class="form-control" id="withdrawal-method">
                        <option value="">Select method</option>
                        <!-- Options will be populated from config -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="withdrawal-address">Wallet Address/ID</label>
                    <input type="text" class="form-control" id="withdrawal-address" placeholder="Enter your wallet address">
                </div>
                <div class="form-group">
                    <label class="form-label" for="withdrawal-amount">Amount (USDT)</label>
                    <input type="number" class="form-control" id="withdrawal-amount" placeholder="0.00" step="0.01">
                </div>
                <div id="withdrawal-info" class="mb-3">
                    <!-- Withdrawal info will be shown here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-modal="withdrawal-modal">Cancel</button>
                <button class="btn btn-primary" id="submit-withdrawal-btn">Submit Request</button>
            </div>
        </div>
    </div>

    <!-- Ad Watch Modal -->
    <div id="ad-modal" class="modal d-none">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Watch Ad</h5>
                <span class="close" data-modal="ad-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="ad-container">
                    <div class="ad-placeholder" id="ad-display">
                        <p>Advertisement will appear here</p>
                    </div>
                    <p>Please watch the ad for 15 seconds to earn rewards.</p>
                    <div class="progress mb-3">
                        <div class="ad-countdown"></div>
                    </div>
                    <button class="btn btn-primary" id="claim-ad-reward-btn" disabled>Claim Reward</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
  apiKey: "AIzaSyDzSDrkS2PNR_fmMotz257Jr3AHCDs_Gqk",
  authDomain: "play2earn-hub-2d522.firebaseapp.com",
  projectId: "play2earn-hub-2d522",
  storageBucket: "play2earn-hub-2d522.firebasestorage.app",
  messagingSenderId: "766809606087",
  appId: "1:766809606087:web:2016a493a5d9edd268fbe2"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global Variables
        let currentUser = null;
        let appConfig = null;
        let currentAdminTab = 'dashboard-tab';
        let currentUserScreen = 'home-screen';
        let weeklyEarnings = [0, 0, 0, 0, 0, 0, 0]; // Store weekly earnings data

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        // Initialize the app based on environment - FIXED DETECTION
        function initializeApp() {
            // Check if we're in Telegram Mini App environment - IMPROVED DETECTION
            const urlParams = new URLSearchParams(window.location.search);
            const isTelegram = window.Telegram && window.Telegram.WebApp && 
                              window.Telegram.WebApp.initData && 
                              window.Telegram.WebApp.initData !== '';
            
            console.log('Telegram environment detected:', isTelegram);
            
            if (isTelegram) {
                // Telegram Mini App environment - show user panel
                document.getElementById('user-panel').classList.remove('d-none');
                document.getElementById('admin-panel').classList.add('d-none');
                
                // Initialize Telegram WebApp
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                
                // Get user data from Telegram
                const tgUser = Telegram.WebApp.initDataUnsafe.user;
                if (tgUser) {
                    initializeUser(tgUser);
                } else {
                    // Fallback for testing
                    console.log('No Telegram user data, using test data');
                    initializeUser({
                        id: 'test_user_123',
                        first_name: 'Test User',
                        username: 'testuser'
                    });
                }
                
                // Initialize mining graph
                initializeMiningGraph();
            } else {
                // Browser environment - show admin panel
                document.getElementById('user-panel').classList.add('d-none');
                document.getElementById('admin-panel').classList.remove('d-none');
                
                // Check if admin is already logged in
                checkAdminAuth();
            }
            
            // Load app configuration
            loadAppConfig();
        }

        // Initialize mining graph with dynamic data
        function initializeMiningGraph() {
            const graphContainer = document.getElementById('mining-graph');
            graphContainer.innerHTML = '';
            
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            
            // Generate random mining data for the week
            weeklyEarnings = weeklyEarnings.map(() => Math.random() * 2.5);
            
            days.forEach((day, index) => {
                const barContainer = document.createElement('div');
                barContainer.className = 'graph-bar';
                
                const barValue = document.createElement('div');
                barValue.className = 'graph-bar-value';
                // Set height based on earnings (max 150px height)
                const height = Math.max(10, (weeklyEarnings[index] / 2.5) * 120);
                barValue.style.height = `${height}px`;
                
                const barLabel = document.createElement('div');
                barLabel.className = 'graph-bar-label';
                barLabel.textContent = day;
                
                const earningsLabel = document.createElement('div');
                earningsLabel.className = 'graph-bar-label';
                earningsLabel.textContent = `${weeklyEarnings[index].toFixed(2)}`;
                earningsLabel.style.fontSize = '10px';
                earningsLabel.style.color = 'var(--success-color)';
                
                barContainer.appendChild(barValue);
                barContainer.appendChild(earningsLabel);
                barContainer.appendChild(barLabel);
                
                graphContainer.appendChild(barContainer);
            });
        }

        // Setup event listeners for the entire app
        function setupEventListeners() {
            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            
            // User panel navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    switchUserScreen(this.getAttribute('data-screen'));
                });
            });
            
            // User panel tabs
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    switchTab(this.getAttribute('data-tab'));
                });
            });
            
            // Admin panel navigation
            document.querySelectorAll('.admin-nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    switchAdminTab(this.getAttribute('data-admin-tab'));
                });
            });
            
            // Admin login
            document.getElementById('admin-login-btn').addEventListener('click', adminLogin);
            document.getElementById('admin-logout-btn').addEventListener('click', adminLogout);
            
            // User actions - FIXED EVENT LISTENERS
            document.getElementById('transfer-btn').addEventListener('click', transferToMainBalance);
            document.getElementById('watch-ad-btn').addEventListener('click', openAdModal);
            document.getElementById('claim-ad-reward-btn').addEventListener('click', claimAdReward);
            document.getElementById('copy-link-btn').addEventListener('click', copyReferralLink);
            document.getElementById('withdraw-btn').addEventListener('click', openWithdrawalModal);
            document.getElementById('submit-withdrawal-btn').addEventListener('click', submitWithdrawal);
            
            // Admin actions
            document.getElementById('add-task-btn').addEventListener('click', addTask);
            document.getElementById('save-config-btn').addEventListener('click', saveAppConfig);
            
            // Modal close buttons
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    const modalId = this.getAttribute('data-modal');
                    closeModal(modalId);
                });
            });
            
            // Close modal when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(this.id);
                    }
                });
            });
            
            // Add event listener for saving user edits
            document.getElementById('save-user-btn').addEventListener('click', saveUserEdits);
        }

        // Initialize user data
        async function initializeUser(tgUser) {
            try {
                // Update UI with user data
                document.getElementById('user-name').textContent = tgUser.first_name || 'User';
                document.getElementById('user-username').textContent = `@${tgUser.username || 'user'}`;
                
                // Check if user exists in Firestore
                const userDoc = await db.collection('users').doc(tgUser.id.toString()).get();
                
                if (userDoc.exists) {
                    // User exists, load their data
                    currentUser = userDoc.data();
                    currentUser.id = tgUser.id.toString();
                    updateUserUI();
                } else {
                    // Create new user
                    currentUser = {
                        id: tgUser.id.toString(),
                        username: tgUser.username || '',
                        firstName: tgUser.first_name || '',
                        mainBalance: 0,
                        earningBalance: 0,
                        referrals: 0,
                        totalAdsWatched: 0,
                        lastAdWatchTimestamp: null,
                        completedBonusTasks: [],
                        joinDate: firebase.firestore.FieldValue.serverTimestamp(),
                        weeklyEarnings: [0, 0, 0, 0, 0, 0, 0]
                    };
                    
                    await db.collection('users').doc(tgUser.id.toString()).set(currentUser);
                    updateUserUI();
                }
                
                // Load user-specific data
                loadBonusTasks();
                loadLeaderboard();
                loadWithdrawalHistory();
            } catch (error) {
                console.error('Error initializing user:', error);
            }
        }

        // Update user UI with current data
        function updateUserUI() {
            if (!currentUser) return;
            
            document.getElementById('main-balance').textContent = `${currentUser.mainBalance.toFixed(2)} USDT`;
            document.getElementById('earning-balance').textContent = `${currentUser.earningBalance.toFixed(2)} USDT`;
            document.getElementById('today-ads').textContent = `${getTodayAdsWatched()}/${appConfig?.dailyAdLimit || 20}`;
            document.getElementById('total-referrals').textContent = currentUser.referrals || 0;
            document.getElementById('total-ads').textContent = currentUser.totalAdsWatched || 0;
            document.getElementById('total-income').textContent = `${(currentUser.mainBalance + (currentUser.earningBalance || 0)).toFixed(2)} USDT`;
            
            // Update ad progress
            const todayAds = getTodayAdsWatched();
            const dailyLimit = appConfig?.dailyAdLimit || 20;
            const progressPercent = (todayAds / dailyLimit) * 100;
            
            document.getElementById('ad-progress-text').textContent = `${todayAds}/${dailyLimit}`;
            document.getElementById('ad-progress-bar').style.width = `${progressPercent}%`;
            
            // Update transfer button state
            const minTransfer = appConfig?.minTransferAmount || 10;
            const transferBtn = document.getElementById('transfer-btn');
            
            if (currentUser.earningBalance >= minTransfer) {
                transferBtn.disabled = false;
            } else {
                transferBtn.disabled = true;
            }
            
            document.getElementById('min-transfer-text').textContent = `Minimum ${minTransfer} USDT to transfer`;
            
            // Update withdrawal condition - ALLOW WITHDRAWAL EVEN WITH 0 REFERRALS
            const minReferrals = appConfig?.minWithdrawalReferrals || 0;
            if (minReferrals > 0) {
                document.getElementById('withdrawal-condition').textContent = 
                    `You need at least ${minReferrals} referrals to be eligible for withdrawal.`;
            } else {
                document.getElementById('withdrawal-condition').textContent = 
                    `You are eligible for withdrawal.`;
            }
            
            // Update referral link
            document.getElementById('referral-link-input').value = 
                `https://t.me/YourBotUsername/SuperAirDrop?startapp=ref_${currentUser.id}`;
        }

        // Get today's ads watched count
        function getTodayAdsWatched() {
            if (!currentUser || !currentUser.lastAdWatchTimestamp) return 0;
            
            const lastWatch = currentUser.lastAdWatchTimestamp.toDate();
            const today = new Date();
            
            // Check if last watch was today
            if (
                lastWatch.getDate() === today.getDate() &&
                lastWatch.getMonth() === today.getMonth() &&
                lastWatch.getFullYear() === today.getFullYear()
            ) {
                // For demo purposes, we'll return a mock value
                // In a real app, you'd track daily ads separately
                return Math.min(5, appConfig?.dailyAdLimit || 20);
            }
            
            return 0;
        }

        // Switch between user screens
        function switchUserScreen(screenId) {
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-screen="${screenId}"]`).classList.add('active');
            
            // Update active screen
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            currentUserScreen = screenId;
        }

        // Switch between tabs in user panel
        function switchTab(tabId) {
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            // Update active tab content
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        }

        // Switch between admin tabs
        function switchAdminTab(tabId) {
            // Update active nav item
            document.querySelectorAll('.admin-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-admin-tab="${tabId}"]`).classList.add('active');
            
            // Update active tab content
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            
            currentAdminTab = tabId;
            
            // Load tab-specific data
            if (tabId === 'users-tab') {
                loadUsersTable();
            } else if (tabId === 'tasks-tab') {
                loadTasksTable();
            } else if (tabId === 'withdrawals-tab') {
                loadWithdrawalsTable();
            } else if (tabId === 'dashboard-tab') {
                loadDashboardStats();
            }
        }

        // Toggle between light and dark theme
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const themeIcon = document.getElementById('theme-icon');
            
            if (currentTheme === 'dark') {
                document.documentElement.removeAttribute('data-theme');
                themeIcon.textContent = '🌙';
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '☀️';
            }
        }

        // Load app configuration from Firestore
        async function loadAppConfig() {
            try {
                const configDoc = await db.collection('appConfig').doc('settings').get();
                
                if (configDoc.exists) {
                    appConfig = configDoc.data();
                } else {
                    // Create default config - SET minWithdrawalReferrals TO 0
                    appConfig = {
                        dailyAdReward: 0.05,
                        dailyAdLimit: 20,
                        referralBonus: 0.50,
                        minTransferAmount: 10,
                        minWithdrawalReferrals: 0, // Changed to 0 to allow withdrawal without referrals
                        withdrawalMethods: [
                            { name: "USDT (BEP-20)", min: 50 },
                            { name: "USDT (TRC-20)", min: 50 }
                        ]
                    };
                    
                    await db.collection('appConfig').doc('settings').set(appConfig);
                }
                
                // Update UI if in admin panel
                if (document.getElementById('admin-panel') && 
                    !document.getElementById('admin-panel').classList.contains('d-none')) {
                    updateConfigUI();
                }
                
                // Update user UI if needed
                if (currentUser) {
                    updateUserUI();
                }
            } catch (error) {
                console.error('Error loading app config:', error);
            }
        }

        // Update admin config UI with current values
        function updateConfigUI() {
            if (!appConfig) return;
            
            document.getElementById('daily-ad-reward').value = appConfig.dailyAdReward;
            document.getElementById('daily-ad-limit').value = appConfig.dailyAdLimit;
            document.getElementById('referral-bonus').value = appConfig.referralBonus;
            document.getElementById('min-transfer-amount').value = appConfig.minTransferAmount;
            document.getElementById('min-withdrawal-referrals').value = appConfig.minWithdrawalReferrals;
            document.getElementById('withdrawal-methods').value = JSON.stringify(appConfig.withdrawalMethods, null, 2);
        }

        // Save app configuration to Firestore
        async function saveAppConfig() {
            try {
                const updatedConfig = {
                    dailyAdReward: parseFloat(document.getElementById('daily-ad-reward').value),
                    dailyAdLimit: parseInt(document.getElementById('daily-ad-limit').value),
                    referralBonus: parseFloat(document.getElementById('referral-bonus').value),
                    minTransferAmount: parseFloat(document.getElementById('min-transfer-amount').value),
                    minWithdrawalReferrals: parseInt(document.getElementById('min-withdrawal-referrals').value),
                    withdrawalMethods: JSON.parse(document.getElementById('withdrawal-methods').value)
                };
                
                await db.collection('appConfig').doc('settings').set(updatedConfig);
                appConfig = updatedConfig;
                
                alert('Configuration saved successfully!');
            } catch (error) {
                console.error('Error saving app config:', error);
                alert('Error saving configuration. Please check your inputs.');
            }
        }

        // Transfer earning balance to main balance
        async function transferToMainBalance() {
            if (!currentUser) return;
            
            const minTransfer = appConfig?.minTransferAmount || 10;
            
            if (currentUser.earningBalance < minTransfer) {
                alert(`You need at least ${minTransfer} USDT to transfer.`);
                return;
            }
            
            try {
                // Update user data in Firestore
                await db.collection('users').doc(currentUser.id).update({
                    mainBalance: firebase.firestore.FieldValue.increment(currentUser.earningBalance),
                    earningBalance: 0
                });
                
                // Update local user data
                currentUser.mainBalance += currentUser.earningBalance;
                currentUser.earningBalance = 0;
                
                updateUserUI();
                alert('Funds transferred successfully!');
            } catch (error) {
                console.error('Error transferring funds:', error);
                alert('Error transferring funds. Please try again.');
            }
        }

        // Open ad watch modal - FIXED: Ads only show when button clicked
        function openAdModal() {
            const todayAds = getTodayAdsWatched();
            const dailyLimit = appConfig?.dailyAdLimit || 20;
            
            if (todayAds >= dailyLimit) {
                alert('You have reached your daily ad limit. Come back tomorrow!');
                return;
            }
            
            openModal('ad-modal');
            
            // Display ad only when modal opens
            displayAdInModal();
            
            // Enable claim button after 15 seconds
            setTimeout(() => {
                document.getElementById('claim-ad-reward-btn').disabled = false;
            }, 15000);
        }

        // Display ad in modal
        function displayAdInModal() {
            const adContainer = document.getElementById('ad-display');
            adContainer.innerHTML = '';
            
            // Create ad element
            const adElement = document.createElement('div');
            adElement.className = 'ad-unit';
            adElement.style.width = '100%';
            adElement.style.height = '200px';
            adElement.style.background = 'linear-gradient(45deg, #f0f0f0, #e0e0e0)';
            adElement.style.display = 'flex';
            adElement.style.alignItems = 'center';
            adElement.style.justifyContent = 'center';
            adElement.style.borderRadius = '8px';
            adElement.innerHTML = '<p>Advertisement Content</p>';
            
            adContainer.appendChild(adElement);
            
            // If ad script is available, use it
            if (window.show_10008240) {
                try {
                    window.show_10008240(adElement);
                } catch (error) {
                    console.error('Error displaying ad:', error);
                    adElement.innerHTML = '<p>Advertisement - Watch for 15 seconds</p>';
                }
            }
        }

        // Claim ad reward
        async function claimAdReward() {
            if (!currentUser) return;
            
            const adReward = appConfig?.dailyAdReward || 0.05;
            
            try {
                // Update user data in Firestore
                await db.collection('users').doc(currentUser.id).update({
                    earningBalance: firebase.firestore.FieldValue.increment(adReward),
                    totalAdsWatched: firebase.firestore.FieldValue.increment(1),
                    lastAdWatchTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local user data
                currentUser.earningBalance += adReward;
                currentUser.totalAdsWatched = (currentUser.totalAdsWatched || 0) + 1;
                currentUser.lastAdWatchTimestamp = new Date();
                
                updateUserUI();
                closeModal('ad-modal');
                alert(`You earned ${adReward} USDT!`);
            } catch (error) {
                console.error('Error claiming ad reward:', error);
                alert('Error claiming reward. Please try again.');
            }
        }

        // Copy referral link to clipboard
        function copyReferralLink() {
            const referralInput = document.getElementById('referral-link-input');
            referralInput.select();
            document.execCommand('copy');
            alert('Referral link copied to clipboard!');
        }

        // Open withdrawal modal - FIXED: Proper validation
        function openWithdrawalModal() {
            if (!currentUser) {
                alert('User not initialized. Please refresh the page.');
                return;
            }
            
            // MODIFIED: Allow withdrawal even with 0 referrals
            const minReferrals = appConfig?.minWithdrawalReferrals || 0;
            
            if (minReferrals > 0 && currentUser.referrals < minReferrals) {
                alert(`You need at least ${minReferrals} referrals to withdraw funds.`);
                return;
            }
            
            if (currentUser.mainBalance <= 0) {
                alert('You have no funds to withdraw.');
                return;
            }
            
            // Populate withdrawal methods
            const methodSelect = document.getElementById('withdrawal-method');
            methodSelect.innerHTML = '<option value="">Select method</option>';
            
            if (appConfig && appConfig.withdrawalMethods) {
                appConfig.withdrawalMethods.forEach(method => {
                    const option = document.createElement('option');
                    option.value = method.name;
                    option.textContent = `${method.name} (Min: ${method.min} USDT)`;
                    methodSelect.appendChild(option);
                });
            }
            
            // Reset form
            document.getElementById('withdrawal-address').value = '';
            document.getElementById('withdrawal-amount').value = '';
            document.getElementById('withdrawal-info').innerHTML = '';
            
            // Update withdrawal info
            const withdrawalInfo = document.getElementById('withdrawal-info');
            withdrawalInfo.innerHTML = `
                <div class="alert alert-info">
                    <strong>Available Balance:</strong> ${currentUser.mainBalance.toFixed(2)} USDT<br>
                    <strong>Minimum Withdrawal:</strong> 50 USDT
                </div>
            `;
            
            openModal('withdrawal-modal');
        }

        // Submit withdrawal request - FIXED: Proper validation and error handling
        async function submitWithdrawal() {
            if (!currentUser) {
                alert('User not initialized. Please refresh the page.');
                return;
            }
            
            const method = document.getElementById('withdrawal-method').value;
            const address = document.getElementById('withdrawal-address').value.trim();
            const amount = parseFloat(document.getElementById('withdrawal-amount').value);
            
            if (!method) {
                alert('Please select a withdrawal method.');
                return;
            }
            
            if (!address) {
                alert('Please enter your wallet address.');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid withdrawal amount.');
                return;
            }
            
            // Find selected method details
            const selectedMethod = appConfig.withdrawalMethods.find(m => m.name === method);
            
            if (!selectedMethod) {
                alert('Invalid withdrawal method.');
                return;
            }
            
            if (amount < selectedMethod.min) {
                alert(`Minimum withdrawal amount for ${method} is ${selectedMethod.min} USDT.`);
                return;
            }
            
            if (amount > currentUser.mainBalance) {
                alert('Insufficient balance.');
                return;
            }
            
            try {
                // Create withdrawal request
                const withdrawalData = {
                    userId: currentUser.id,
                    username: currentUser.username,
                    firstName: currentUser.firstName,
                    amount: amount,
                    method: method,
                    walletAddress: address,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('withdrawals').add(withdrawalData);
                
                // Deduct amount from user's main balance
                await db.collection('users').doc(currentUser.id).update({
                    mainBalance: firebase.firestore.FieldValue.increment(-amount)
                });
                
                // Update local user data
                currentUser.mainBalance -= amount;
                
                updateUserUI();
                closeModal('withdrawal-modal');
                alert('Withdrawal request submitted successfully!');
                
                // Reload withdrawal history
                loadWithdrawalHistory();
            } catch (error) {
                console.error('Error submitting withdrawal:', error);
                alert('Error submitting withdrawal request. Please try again.');
            }
        }

        // Load bonus tasks for user
        async function loadBonusTasks() {
            try {
                const tasksSnapshot = await db.collection('tasks').get();
                const tasksList = document.getElementById('bonus-tasks-list');
                tasksList.innerHTML = '';
                
                tasksSnapshot.forEach(doc => {
                    const task = doc.data();
                    task.id = doc.id;
                    
                    const isCompleted = currentUser.completedBonusTasks && 
                                       currentUser.completedBonusTasks.includes(task.id);
                    
                    const taskElement = document.createElement('div');
                    taskElement.className = 'task-item';
                    taskElement.innerHTML = `
                        <div class="task-info">
                            <h4>${task.title}</h4>
                            <p>${task.description}</p>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="task-reward mr-2">${task.reward} USDT</span>
                            <button class="btn ${isCompleted ? 'btn-secondary' : 'btn-primary'}" 
                                    ${isCompleted ? 'disabled' : ''} 
                                    data-task-id="${task.id}">
                                ${isCompleted ? 'Claimed' : 'Claim Bonus'}
                            </button>
                        </div>
                    `;
                    
                    tasksList.appendChild(taskElement);
                    
                    // Add event listener for claim button
                    if (!isCompleted) {
                        taskElement.querySelector('button').addEventListener('click', () => claimBonusTask(task.id, task.reward));
                    }
                });
            } catch (error) {
                console.error('Error loading bonus tasks:', error);
            }
        }

        // Claim bonus task reward
        async function claimBonusTask(taskId, reward) {
            if (!currentUser) return;
            
            try {
                // Update user data in Firestore
                await db.collection('users').doc(currentUser.id).update({
                    earningBalance: firebase.firestore.FieldValue.increment(reward),
                    completedBonusTasks: firebase.firestore.FieldValue.arrayUnion(taskId)
                });
                
                // Update local user data
                currentUser.earningBalance += reward;
                if (!currentUser.completedBonusTasks) {
                    currentUser.completedBonusTasks = [];
                }
                currentUser.completedBonusTasks.push(taskId);
                
                updateUserUI();
                loadBonusTasks(); // Reload tasks to update UI
                alert(`You earned ${reward} USDT!`);
            } catch (error) {
                console.error('Error claiming bonus task:', error);
                alert('Error claiming bonus. Please try again.');
            }
        }

        // Load leaderboard data
        async function loadLeaderboard() {
            try {
                // Load top referrers
                const referrersSnapshot = await db.collection('users')
                    .orderBy('referrals', 'desc')
                    .limit(50)
                    .get();
                
                const referrersList = document.getElementById('referrers-list');
                referrersList.innerHTML = '';
                
                let rank = 1;
                referrersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const listItem = createLeaderboardItem(rank, user, user.referrals, 'referrals');
                    referrersList.appendChild(listItem);
                    rank++;
                });
                
                // Load top earners
                const earnersSnapshot = await db.collection('users')
                    .orderBy('mainBalance', 'desc')
                    .limit(50)
                    .get();
                
                const earnersList = document.getElementById('earners-list');
                earnersList.innerHTML = '';
                
                rank = 1;
                earnersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const listItem = createLeaderboardItem(rank, user, user.mainBalance, 'USDT');
                    earnersList.appendChild(listItem);
                    rank++;
                });
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        // Create leaderboard list item
        function createLeaderboardItem(rank, user, score, unit) {
            const listItem = document.createElement('div');
            listItem.className = 'leaderboard-item';
            
            listItem.innerHTML = `
                <div class="leaderboard-rank">#${rank}</div>
                <div class="leaderboard-user">
                    <div class="leaderboard-avatar">
                        <i>👤</i>
                    </div>
                    <div class="leaderboard-details">
                        <h4>${user.firstName || 'User'}</h4>
                        <p>@${user.username || 'user'}</p>
                    </div>
                </div>
                <div class="leaderboard-score">${score} ${unit}</div>
            `;
            
            return listItem;
        }

        // Load withdrawal history for user
        async function loadWithdrawalHistory() {
            if (!currentUser) return;
            
            try {
                const withdrawalsSnapshot = await db.collection('withdrawals')
                    .where('userId', '==', currentUser.id)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const historyContainer = document.getElementById('withdrawal-history');
                historyContainer.innerHTML = '';
                
                if (withdrawalsSnapshot.empty) {
                    historyContainer.innerHTML = '<p class="text-center">No withdrawal history</p>';
                    return;
                }
                
                withdrawalsSnapshot.forEach(doc => {
                    const withdrawal = doc.data();
                    const listItem = document.createElement('div');
                    listItem.className = 'withdrawal-item';
                    
                    const date = withdrawal.createdAt ? 
                        withdrawal.createdAt.toDate().toLocaleDateString() : 'N/A';
                    
                    let statusBadge = '';
                    if (withdrawal.status === 'pending') {
                        statusBadge = '<span class="badge badge-warning">Pending</span>';
                    } else if (withdrawal.status === 'approved') {
                        statusBadge = '<span class="badge badge-success">Approved</span>';
                    } else if (withdrawal.status === 'rejected') {
                        statusBadge = '<span class="badge badge-danger">Rejected</span>';
                    }
                    
                    listItem.innerHTML = `
                        <div class="withdrawal-info">
                            <h4>${withdrawal.amount} USDT</h4>
                            <p>${withdrawal.method} • ${date}</p>
                        </div>
                        <div>
                            ${statusBadge}
                        </div>
                    `;
                    
                    historyContainer.appendChild(listItem);
                });
            } catch (error) {
                console.error('Error loading withdrawal history:', error);
            }
        }

        // Admin authentication
        async function adminLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            
            if (!email || !password) {
                alert('Please enter email and password.');
                return;
            }
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                document.getElementById('admin-login').classList.add('d-none');
                document.getElementById('admin-dashboard').classList.remove('d-none');
                
                // Load initial data
                loadDashboardStats();
            } catch (error) {
                console.error('Error logging in:', error);
                alert('Invalid email or password.');
            }
        }

        // Check if admin is already logged in
        function checkAdminAuth() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('admin-login').classList.add('d-none');
                    document.getElementById('admin-dashboard').classList.remove('d-none');
                    
                    // Load initial data
                    loadDashboardStats();
                }
            });
        }

        // Admin logout
        function adminLogout() {
            auth.signOut();
            document.getElementById('admin-login').classList.remove('d-none');
            document.getElementById('admin-dashboard').classList.add('d-none');
        }

        // Load dashboard statistics for admin
        async function loadDashboardStats() {
            try {
                // Get total users
                const usersSnapshot = await db.collection('users').get();
                document.getElementById('admin-total-users').textContent = usersSnapshot.size;
                
                // Calculate total USDT earned
                let totalEarned = 0;
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    totalEarned += (user.mainBalance || 0) + (user.earningBalance || 0);
                });
                document.getElementById('admin-total-earned').textContent = `${totalEarned.toFixed(2)} USDT`;
                
                // Get pending withdrawals count
                const pendingWithdrawalsSnapshot = await db.collection('withdrawals')
                    .where('status', '==', 'pending')
                    .get();
                document.getElementById('admin-pending-withdrawals').textContent = pendingWithdrawalsSnapshot.size;
                
                // Get approved withdrawals count
                const approvedWithdrawalsSnapshot = await db.collection('withdrawals')
                    .where('status', '==', 'approved')
                    .get();
                document.getElementById('admin-approved-withdrawals').textContent = approvedWithdrawalsSnapshot.size;
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        // Load users table for admin
        async function loadUsersTable() {
            try {
                const usersSnapshot = await db.collection('users').get();
                const tableBody = document.getElementById('users-table-body');
                tableBody.innerHTML = '';
                
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    user.id = doc.id;
                    
                    const joinDate = user.joinDate ? 
                        user.joinDate.toDate().toLocaleDateString() : 'N/A';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.username || 'N/A'}</td>
                        <td>${user.mainBalance ? user.mainBalance.toFixed(2) : '0.00'} USDT</td>
                        <td>${user.earningBalance ? user.earningBalance.toFixed(2) : '0.00'} USDT</td>
                        <td>${user.referrals || 0}</td>
                        <td>${joinDate}</td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-user-btn" data-user-id="${user.id}">Edit</button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to edit buttons
                document.querySelectorAll('.edit-user-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const userId = this.getAttribute('data-user-id');
                        openUserEditModal(userId);
                    });
                });
            } catch (error) {
                console.error('Error loading users table:', error);
            }
        }

        // Open user edit modal
        async function openUserEditModal(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                
                if (!userDoc.exists) {
                    alert('User not found.');
                    return;
                }
                
                const user = userDoc.data();
                
                document.getElementById('edit-user-id').value = userId;
                document.getElementById('edit-username').value = user.username || '';
                document.getElementById('edit-main-balance').value = user.mainBalance || 0;
                document.getElementById('edit-earning-balance').value = user.earningBalance || 0;
                document.getElementById('edit-referrals').value = user.referrals || 0;
                
                openModal('user-edit-modal');
            } catch (error) {
                console.error('Error opening user edit modal:', error);
                alert('Error loading user data.');
            }
        }

        // Save user edits
        async function saveUserEdits() {
            const userId = document.getElementById('edit-user-id').value;
            const username = document.getElementById('edit-username').value;
            const mainBalance = parseFloat(document.getElementById('edit-main-balance').value);
            const earningBalance = parseFloat(document.getElementById('edit-earning-balance').value);
            const referrals = parseInt(document.getElementById('edit-referrals').value);
            
            try {
                await db.collection('users').doc(userId).update({
                    username: username,
                    mainBalance: mainBalance,
                    earningBalance: earningBalance,
                    referrals: referrals
                });
                
                closeModal('user-edit-modal');
                loadUsersTable(); // Reload table
                alert('User updated successfully!');
            } catch (error) {
                console.error('Error updating user:', error);
                alert('Error updating user. Please try again.');
            }
        }

        // Load tasks table for admin
        async function loadTasksTable() {
            try {
                const tasksSnapshot = await db.collection('tasks').get();
                const tableBody = document.getElementById('tasks-table-body');
                tableBody.innerHTML = '';
                
                tasksSnapshot.forEach(doc => {
                    const task = doc.data();
                    task.id = doc.id;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${task.title}</td>
                        <td>${task.description}</td>
                        <td>${task.reward} USDT</td>
                        <td>
                            <button class="btn btn-sm btn-danger delete-task-btn" data-task-id="${task.id}">Delete</button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-task-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const taskId = this.getAttribute('data-task-id');
                        if (confirm('Are you sure you want to delete this task?')) {
                            deleteTask(taskId);
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading tasks table:', error);
            }
        }

        // Add new task
        async function addTask() {
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const reward = parseFloat(document.getElementById('task-reward').value);
            const url = document.getElementById('task-url').value;
            
            if (!title || !description || !reward) {
                alert('Please fill in all required fields.');
                return;
            }
            
            try {
                await db.collection('tasks').add({
                    title: title,
                    description: description,
                    reward: reward,
                    url: url
                });
                
                // Clear form
                document.getElementById('task-title').value = '';
                document.getElementById('task-description').value = '';
                document.getElementById('task-reward').value = '';
                document.getElementById('task-url').value = '';
                
                loadTasksTable(); // Reload table
                alert('Task added successfully!');
            } catch (error) {
                console.error('Error adding task:', error);
                alert('Error adding task. Please try again.');
            }
        }

        // Delete task
        async function deleteTask(taskId) {
            try {
                await db.collection('tasks').doc(taskId).delete();
                loadTasksTable(); // Reload table
                alert('Task deleted successfully!');
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Error deleting task. Please try again.');
            }
        }

        // Load withdrawals table for admin
        async function loadWithdrawalsTable() {
            try {
                const withdrawalsSnapshot = await db.collection('withdrawals')
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const tableBody = document.getElementById('withdrawals-table-body');
                tableBody.innerHTML = '';
                
                if (withdrawalsSnapshot.empty) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="6" class="text-center">No pending withdrawals</td>`;
                    tableBody.appendChild(row);
                    return;
                }
                
                withdrawalsSnapshot.forEach(doc => {
                    const withdrawal = doc.data();
                    withdrawal.id = doc.id;
                    
                    const date = withdrawal.createdAt ? 
                        withdrawal.createdAt.toDate().toLocaleDateString() : 'N/A';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${date}</td>
                        <td>${withdrawal.username || withdrawal.firstName || 'User'}</td>
                        <td>${withdrawal.amount} USDT</td>
                        <td>${withdrawal.walletAddress}</td>
                        <td>${withdrawal.method}</td>
                        <td>
                            <button class="btn btn-sm btn-success approve-withdrawal-btn" data-withdrawal-id="${withdrawal.id}">Approve</button>
                            <button class="btn btn-sm btn-danger reject-withdrawal-btn" data-withdrawal-id="${withdrawal.id}">Reject</button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to action buttons
                document.querySelectorAll('.approve-withdrawal-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const withdrawalId = this.getAttribute('data-withdrawal-id');
                        updateWithdrawalStatus(withdrawalId, 'approved');
                    });
                });
                
                document.querySelectorAll('.reject-withdrawal-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const withdrawalId = this.getAttribute('data-withdrawal-id');
                        updateWithdrawalStatus(withdrawalId, 'rejected');
                    });
                });
            } catch (error) {
                console.error('Error loading withdrawals table:', error);
            }
        }

        // Update withdrawal status
        async function updateWithdrawalStatus(withdrawalId, status) {
            try {
                await db.collection('withdrawals').doc(withdrawalId).update({
                    status: status
                });
                
                // If rejected, return funds to user
                if (status === 'rejected') {
                    const withdrawalDoc = await db.collection('withdrawals').doc(withdrawalId).get();
                    const withdrawal = withdrawalDoc.data();
                    
                    await db.collection('users').doc(withdrawal.userId).update({
                        mainBalance: firebase.firestore.FieldValue.increment(withdrawal.amount)
                    });
                }
                
                loadWithdrawalsTable(); // Reload table
                loadDashboardStats(); // Update dashboard stats
                alert(`Withdrawal ${status} successfully!`);
            } catch (error) {
                console.error('Error updating withdrawal status:', error);
                alert('Error updating withdrawal. Please try again.');
            }
        }

        // Open modal
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('d-none');
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('d-none');
        }
    </script>
</body>
</html>